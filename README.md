# Magic Patterns - Vite Template

This code was generated by [Magic Patterns](https://magicpatterns.com) for this design: [Source Design](https://www.magicpatterns.com/c/3zhmag45kr5ut3nych27jr)

## Getting Started

1. Run `npm install`
2. Run `npm run dev`

## Owner Portal MVP

- Protected route: `/owner` (lazy-loaded)
- Owners see metrics for their restaurant(s); if none, they can submit a claim.
- Admins approve claims by setting `users/{uid}.isAdmin: true` and using an admin tool to call `adminApproveClaim` (or via console):
  - Approving adds the user to `restaurants/{id}.ownerIds` and marks `owner_claims/{id}` as `approved`.

What it shows (30d window):
- Reviews count, unique reviewers, % change vs prior 30d
- Trend chart (reviews per day)
- Top tags (30d)
- Top dishes table (posts, avg rating, top tags)
- Recent photos grid (latest 12)
- Deals panel: create a draft and submit for approval; list deals and statuses

Security
- Only restaurant owners (by `restaurants/{id}.ownerIds`) or admins can view stats and deals for a restaurant.
- Anyone can submit an `owner_claims` document; only admins can approve.
- Owners can create/edit deals and submit; admins approve/reject.

Indexes added
- `owner_claims`: `(requesterUid ASC, createdAt DESC)`
- `deals`: `(restaurantId ASC, createdAt DESC)`

How to test
- As a user, go to `/owner` and submit a claim for a known `restaurants/{id}`.
- As admin, approve the claim (adds uid to `restaurants/{id}.ownerIds`).
- Refresh `/owner`; you should now see the dashboard for that restaurant.
- Create a deal and confirm it appears with `submitted` status.

Audit summary (data reused)
- `reviews`: rating, createdAt, userId, restaurantId, menuItemId, dishName, tags[], images/media.photos (see docs/reviews-reads.md)
- `restaurants`: name, cuisine(s), coordinates, qualityScore; Cloud Function updates `cuisines`
- `menuItems`: dish-level docs used to group reviews by dish
- `xp_events`: exists for user rewards (not used in MVP analytics)

Phase 2 suggestions
- Sentiment over time by tag; posting time heatmaps; repeat vs first-time cohorts; local benchmarking; deal conversion tracking once surfaced publicly.
### Stats Caching
- The owner dashboard reads `restaurant_stats/{restaurantId}`.
- If `lastUpdated` is older than ~6 hours, the app recomputes 30-day KPIs client-side and refreshes the cache.
- This reduces read/compute cost and keeps the UI snappy.
- TODO: move aggregation to Cloud Functions and lock client writes.
